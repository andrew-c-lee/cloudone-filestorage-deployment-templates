# Copyright (C) 2022 Trend Micro Inc. All rights reserved.

imports:
  - path: storage_role.py
  - path: storage_service_account.py
  - path: cloud_function.py
  - path: pubsub.py
  - path: storage.py
  - path: common.py

resources:
- name: storage-stack-role
  type: storage_role.py
  properties:
    action: update
    blRoleID: <BUCKET_LISTENER_ROLE_ID>
    patRoleID: <POST_ACTION_TAG_ROLE_ID>

- name: storage-stack-service-account
  type: storage_service_account.py
  properties:
    bucketListenerRoleID: $(ref.storage-stack-role.bucketListenerRoleID)
    postActionTagRoleID: $(ref.storage-stack-role.postActionTagRoleID)

- name: storage-stack
  type: storage.py
  properties:
    deploymentName: <DEPLOYMENT_NAME>
    region: <REGION>
    scanningBucket: <SCANNING_BUCKET_NAME>
    artifactBucket: <ARTIFACT_BUCKET_NAME>
    scannerTopic: <SCANNER_TOPIC>
    scannerProjectID: <SCANNER_PROJECT_ID>
    scannerServiceAccountID: <SCANNER_SERVICE_ACCOUNT_ID>
    bucketListenerServiceAccountID: $(ref.storage-stack-service-account.bucketListenerServiceAccountID)
    postActionTagServiceAccountID: $(ref.storage-stack-service-account.postActionTagServiceAccountID)
    postActionTagRoleID: $(ref.storage-stack-role.postActionTagRoleID)
    reportObjectKey: <REPORT_OBJECT_KEY>

outputs:
  - name: region
    value: $(ref.storage-stack.region)
  - name: storageProjectID
    value: $(ref.storage-stack.storageProjectID)
  - name: bucketListenerSourceArchiveUrl
    value: $(ref.storage-stack.bucketListenerSourceArchiveUrl)
  - name: bucketListenerServiceAccountID
    value: $(ref.storage-stack-service-account.bucketListenerServiceAccountID)
  - name: bucketListenerRoleID
    value: $(ref.storage-stack-role.bucketListenerRoleID)
  - name: postActionTagServiceAccountID
    value: $(ref.storage-stack-service-account.postActionTagServiceAccountID)
  - name: postActionTagRoleID
    value: $(ref.storage-stack-role.postActionTagRoleID)
  - name: scanResultTopic
    value: $(ref.storage-stack.scanResultTopic)
  - name: bucketListenerFunctionName
    value: $(ref.storage-stack.bucketListenerFunctionName)
  - name: postScanActionTagFunctionName
    value: $(ref.storage-stack.postScanActionTagFunctionName)
